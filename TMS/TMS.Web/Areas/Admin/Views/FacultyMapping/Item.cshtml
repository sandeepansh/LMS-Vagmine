using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using System.Security.Claims;
using TMS.Repository.Managers;
using TMS.ViewModels.Masters;
using TMS.Web.Controllers;

namespace TMS.Web.Areas.Admin.Controllers
{
    [Area("Admin")]
    public class FacultyMappingController : BaseController
    {
        private readonly IMasterBaseManager<CourseFacultyMapViewModel> _mappingManager;
        private readonly IMasterManager<CourseMasterViewModel> _courseManager;
        private readonly IMasterManager<UserViewModel> _userManager;

        public FacultyMappingController(
            IMasterBaseManager<CourseFacultyMapViewModel> mappingManager,
            IMasterManager<CourseMasterViewModel> courseManager,
            IMasterManager<UserViewModel> userManager)
        {
            _mappingManager = mappingManager;
            _courseManager = courseManager;
            _userManager = userManager;
        }

        public async Task<IActionResult> Index()
        {
            ViewData["Title"] = "Faculty Course Mapping";
            var courses = await _courseManager.GetAsync(null, c => c.IsActive);

            // Get existing mappings
            var allMappings = await _mappingManager.GetAsync(new[] { "Course", "Faculty" });

            // Attach mapped faculty list to each course
            foreach (var course in courses)
            {
                course.MappedFaculties = allMappings
                    .Where(m => m.CourseId == course.Id)
                    .Select(m => m.Faculty)
                    .ToList();
            }

            return View(courses);
        }

        [HttpGet]
        public async Task<IActionResult> ManageMapping(int courseId)
        {
            var faculties = await _userManager.GetAsync(new[] { "Role" }, u => u.IsActive && u.Role!.Name == "Faculty");
            var mappings = await _mappingManager.GetAsync(null, m => m.CourseId == courseId);

            var selectedIds = mappings.Select(m => m.FacultyId).ToList();

            var viewModel = new CourseFacultyMapViewModel
            {
                CourseId = courseId,
                FacultyIds = selectedIds
            };

            ViewBag.CourseName = (await _courseManager.GetAsync(courseId))?.Name ?? "Unknown Course";
            ViewBag.FacultyList = faculties.Select(f => new SelectListItem
            {
                Value = f.Id.ToString(),
                Text = f.Name,
                Selected = selectedIds.Contains(f.Id)
            }).ToList();

            return PartialView("_ManageMapping", viewModel);
        }

        [HttpPost]
        public async Task<IActionResult> SaveMapping(CourseFacultyMapViewModel model)
        {
            // Remove existing mappings
            var existing = await _mappingManager.GetAsync(null, m => m.CourseId == model.CourseId);
            foreach (var map in existing)
                await _mappingManager.DeleteAsync(map.Id);

            // Add new selected mappings
            if (model.FacultyIds != null)
            {
                foreach (var facultyId in model.FacultyIds)
                {
                    await _mappingManager.AddUpdateAsync(new CourseFacultyMapViewModel
                    {
                        CourseId = model.CourseId,
                        FacultyId = facultyId,
                        IsActive = true
                    }, GetUserId());
                }
            }

            return Json(new { success = true, message = "Faculty mappings updated successfully." });
        }

        [HttpGet]
        public async Task<IActionResult> ViewMapping(int courseId)
        {
            var mappings = await _mappingManager.GetAsync(new[] { "Faculty" }, m => m.CourseId == courseId);
            ViewBag.CourseName = (await _courseManager.GetAsync(courseId))?.Name ?? "Unknown Course";
            return PartialView("_ViewMapping", mappings);
        }
    }
}
