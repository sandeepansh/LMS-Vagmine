@model List<TMS.ViewModels.Academics.FacultyQuizAssessmentViewModel>

@{
    ViewData["Title"] = "Faculty Quiz Assessments";
}

<h2>Faculty Quiz Assessments</h2>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Student</th>
            <th>Course</th>
            <th>Quadrant</th>
            <th>Quiz</th>
            <th>Attempted On</th>
            <th>Total Score</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var attempt in Model)
        {
            <tr>
                <td>@attempt.StudentName</td>
                <td>@attempt.CourseName</td>
                <td>@attempt.QuadrantName</td>
                <td>@attempt.QuizName</td>
                <td>@attempt.AttemptedOn.ToString("dd-MM-yyyy HH:mm")</td>
                <td>@attempt.TotalScore</td>
                <td>
                    <button class="btn btn-sm btn-primary view-assessment-btn"
                            data-attemptid="@attempt.AttemptId">
                        View / Assess
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="quizAssessmentModal" tabindex="-1" aria-labelledby="quizAssessmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content" id="assessmentModalContainer">
            <!-- Partial content loaded here -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $(".view-assessment-btn").click(function () {
                var attemptId = $(this).data("attemptid");

                $.ajax({
                    url: '@Url.Action("Details", "FacultyQuizAssessment")',
                    type: 'GET',
                    data: { attemptId: attemptId },
                    success: function (res) {
                        // Inject partial HTML into modal
                        $("#assessmentModalContainer").html(res);

                        // Show the main modal (not nested)
                        $("#quizAssessmentModal").modal("show");
                    },
                    error: function () {
                        alert("Failed to load assessment details.");
                    }
                });
            });

            // Handle form submission from inside partial view
            $(document).on("submit", "#quizAssessmentForm", function (e) {
                e.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("SaveAssessment", "FacultyQuizAssessment")',
                    type: 'POST',
                    data: formData,
                    success: function (res) {
                        if (res.success) {
                            alert("Assessment saved successfully. Total Score: " + res.totalScore);
                            $("#quizAssessmentModal").modal("hide");
                            location.reload(); // optional
                        } else {
                            alert("Failed to save assessment.");
                        }
                    },
                    error: function () {
                        alert("Error saving assessment.");
                    }
                });
            });
        });
    </script>
}
